---
layout: reveal
title: Bridge Existing iOS & Android Apps with React Native
permalink: /presents/bridge-existing-ios-android-apps-react-native/
presented_at: Chicago React Native Meetup
date: 2017-11-16
---

<section data-markdown>

# Bridge Existing iOS & Android Apps with React Native

</section>
<section data-markdown>

## Intro
- Josh
    - https://www.andjosh.com
- OfficeLuv
    - https://www.officeluv.com
- Team
    - https://officeluv.github.io

</section>
<section data-markdown>

## Today
- Our path to React Native
- Problems
- Solutions
- Problems
- Solutions
- Thoughts on our future

</section>
<section data-markdown>

## We Needed
- A screen rewrite existing in iOS/Android companion apps
- Nearly double the screens in those apps
- On both platforms
- Within ~3 weeks

</section>
<section data-markdown>

## What About React Native?
- Consolidate UI
- Double developer resources
- Leverage Yoga (_flexbox_) to fit our design
- Remotely affect UI/functionality?

</section>
<section data-markdown>

## Demo
 Which parts are React Native?

</section>
<section data-markdown>

## Where Is Best?

- Leave existing code intact
- New UIViewControllers, Activities
- New UIViews, Fragments

</section>
<section data-markdown>

## Where Is Trouble?

- Installation will [probably] be a pain
    - Days in our case
- Heavy API integration within the UI
    - Slows integration
- Support of very old Android devices
    - Erodes features & responsiveness

</section>
<section data-markdown>

## Where Is Your Time Spent?

- 1/3 in React Native
- 1/3 building bridges
- 1/3 massaging props

</section>
<section>
<section data-markdown>

## The Installation Process

</section>
<section data-markdown>

## Separate Repos

- To leverage React testing
- To accomodate separate languages/structures
- To allow for separate release cycles

~~~
~/src/
|_ ios-field-staff
|_ android-field-staff
|_ rn-field-staff
~~~

</section>
<section data-markdown>

## iOS Installation

- Clone iOS
- Install latest cocoapods
- Clone RN
- Install node modules
- Symlink to iOS repo
- Start RN bundle server
- Run iOS simulator

</section>
<section data-markdown>

## Android Installation

- Clone Android
- Update and gradle install
- Clone RN
- Install node modules
- Symlink to Android repo
- Start RN bundle server
- Run Android simulator

</section>
</section>
<section data-markdown>

## Building Bridges

- Get in.
- Get out.
- Embrace the _single direction_ of props

</section>
<section >
<section data-markdown>

## Example React Native Bridge
~~~js
import { NativeModules } from 'react-native';
const bridge = NativeModules.CurrentCleaningBridge;
const isImplemented = (name) => {
    if (!bridge || !bridge[name]) {
        console.log(name, 'bridge not implemented');
        return false;
    }
    return true;
}
export const componentDidMount = () => {
    if (!isImplemented('componentDidMount')) return;
    bridge.componentDidMount();
};
~~~

</section>
<section data-markdown>

## Example React Native Bridge With Args
~~~js
import { NativeModules } from 'react-native';
const bridge = NativeModules.CurrentCleaningBridge;
export const onSubmit = (note) => {
    if (!isImplemented('onSubmit')) return;
    bridge.onSubmit(note || '');
};
export const onRootLayout = (x, y, width, height) => {
    if (!isImplemented('onRootLayout')) return;
    bridge.onRootLayout(x || 0, y || 0, width || 0, height || 0);
};
~~~

</section>
<section data-markdown>

## Example React Native Bridge Usage
~~~js
export default class Foo extends React.PureComponent {
    _onLayout = (event) => {
        const { x, y, width, height } =
            event.nativeEvent.layout;
        bridge.onRootLayout(x, y, width, height);
    }
    render() {
        return (
            &lt;View onLayout={this._onLayout}&gt;
            &lt;/View&gt;
    }
}
~~~

</section>
</section>
<section>
<section data-markdown>

## Example Swift iOS Bridge
- Leverage Swift
- Expose modules in Objective-C

</section>
<section data-markdown>

## Obj-C Bridge Implementation

~~~objc
#import "CurrentCleaningBridgingHeader.h"
#import "React/RCTBridgeModule.h"

@interface RCT_EXTERN_MODULE(CurrentCleaningBridge, NSObject)

RCT_EXTERN_METHOD(onSubmit:(NSString * __nonnull)note)
RCT_EXTERN_METHOD(onRootLayout:(NSNumber * __nonnull)x y:(NSNumber * __nonnull)y width:(NSNumber * __nonnull)width height:(NSNumber * __nonnull)height)
RCT_EXTERN_METHOD(componentDidMount)

@end
~~~

</section>
<section data-markdown>

## Obj-C Bridge Header
~~~objc
// Look to the Swift definition...
#ifndef CurrentCleaningBridgingHeader_h
#define CurrentCleaningBridgingHeader_h

#import "React/RCTBridge.h"
#import "React/RCTBridgeModule.h"
#import "React/RCTEventDispatcher.h"

#endif
~~~

</section>
<section data-markdown>

## Swift Bridge
~~~swift
import Foundation
import Firebase

@objc(CurrentCleaningBridge)
class CurrentCleaningBridge: NSObject {

    @objc func componentDidMount() -> Void {
        // good for nothing...
    }

    @objc func onRootLayout(_ x: NSNumber, y: NSNumber, width: NSNumber, height: NSNumber) -> Void {
        RNEmbeddedViews.shared()
            .triggeredLayout(RootView: "CurrentCleaning",
                x: x, y: y, width: width, height: height)
    }
}
~~~

</section>
<section data-markdown>

## Swift Bridge, Continued
~~~swift
@objc(CurrentCleaningBridge)
class CurrentCleaningBridge: NSObject {
    //...
    @objc func onSubmit(_ note: NSString) -> Void {
        FIRAnalytics.logEvent(withName: Constant.Analytics.Events.updateCheckinNote,
            parameters: [:])
        StaffAPIClient.sharedClient()
            .updateCurrentCheckinNote(note: note as String)
        { (checkin, error) in
            if (error != nil) {
                // Handle err....
            }
        }
    }
}
~~~

</section>
</section>
<section>
<section data-markdown>

## Example Java Android Bridge
~~~java
// import ...
public class CurrentCleaningBridge extends ReactContextBaseJavaModule {
    private static final String TAG = "CurrentCleaningBridge";
    public CurrentCleaningBridge(ReactApplicationContext reactContext) {
        super(reactContext);
    }

    @Override
    public String getName() {
        return "CurrentCleaningBridge";
    }
}

~~~

</section>
<section data-markdown>

## Example Java Android Bridge, Continued
~~~java
public class CurrentCleaningBridge extends ReactContextBaseJavaModule {
    // ...
    @ReactMethod
    public void componentDidMount() {
        // good for nothing...
    }

    @ReactMethod
    public void onRootLayout(float x, float y, float width, float height) {
        CurrentCleaningSingleton.getInstance()
            .onRootLayout("CurrentCleaning", x, y, width, height);
    }
}

~~~

</section>
<section data-markdown>

## Example Java Android Bridge, Continued
~~~java
public class CurrentCleaningBridge extends ReactContextBaseJavaModule {
    // ...
    @ReactMethod
    public void onSubmitNote(String note) {
        StaffAPI.getInstance()
            .updateCheckinNote(getReactApplicationContext(), note,
            new APICallbackInterface() {
            @Override
            public void onResponse(VolleyError error, JSONObject response) {
                if (error != null) {
                    // handle error...
                }
            }
        });
    }

    @Override
    public String getName() {
        return "CurrentCleaningBridge";
    }
}

~~~

</section>
</section>
<section data-markdown>

## Communicating to Parent View
- Special brdige case
- Bridges are ad-hoc instances
- How to tell a parent of variable resize?

</section>
<section>
<section data-markdown>

## Example Java Embedded View Singleton
~~~java
public interface RNEmbeddedViewInterface {
    void onRootLayout(String rootView, float x, float y, float width, float height);
}
public class RNEmbeddedViewSingleton {

    private static final RNEmbeddedViewSingleton ourInstance
        = new RNEmbeddedViewSingleton();

    public static RNEmbeddedViewSingleton getInstance() {
        return ourInstance;
    }

    private RNEmbeddedViewSingleton() {
    }
    // ...
}
~~~

</section>
<section data-markdown>

## Example Java Embedded View Singleton
~~~java
// ...
public class RNEmbeddedViewSingleton {
    // ...
    private RNEmbeddedViewInterface mListener;

    public void registerListener(RNEmbeddedViewInterface listener) {
        this.mListener = listener;
    }

    public void removeListener(RNEmbeddedViewInterface listener) {
        if (mListener == listener) {
            this.mListener = null;
        }
    }
    // ...
}
~~~

</section>
<section data-markdown>

## Example Java Embedded View Singleton, Continued
~~~java
// RNEmbeddedViewSingleton.getInstance().registerListener(this);

public class RNEmbeddedViewSingleton {
    //...
    public void onRootLayout(String rootView, float x, float y, float width, float height) {
        if (mListener == null) {
            return;
        }
        mListener.onRootLayout(rootView, x, y, width, height);
    }
}
~~~

</section>
</section>
<section>
<section data-markdown>

## Example Swift Embedded View Singleton
~~~swift
struct RNViewLayout {
    let x: NSNumber
    let y: NSNumber
    let width: NSNumber
    let height: NSNumber
}

protocol RNEmbeddedViewsDelegate {
    func onLayout(RootView: NSString, dimensions: RNViewLayout)
}

class RNEmbeddedViews: NSObject {
    // ...
}
~~~

</section>
<section data-markdown>

## Example Swift Embedded View Singleton, Continued
~~~swift
// ...
class RNEmbeddedViews: NSObject {
    var delegate: RNEmbeddedViewsDelegate?

    class func shared() -> RNEmbeddedViews {
        struct Singleton {
            static let instance = RNEmbeddedViews()
        }
        return Singleton.instance
    }
    // ...
    // RNEmbeddedViews.shared().delegate = self
}
~~~

</section>
<section data-markdown>

## Example Swift Embedded View Singleton, Continued
~~~swift
// ...
class RNEmbeddedViews: NSObject {
    // ...
    func triggeredLayout(RootView: NSString, x: NSNumber, y: NSNumber, width: NSNumber, height: NSNumber) {
        let dimensions = RNViewLayout(x: x, y: y, width: width, height: height)
        self.delegate?.onLayout(RootView: RootView, dimensions: dimensions)
    }
}
~~~

</section>
</section>
<section data-markdown>

## Finding Platform Differences

- Custom navigation control
- Text inputs
- Tactile inputs
- Accessibility features
- Some flexbox layouts
    - Conflixts with Flat UI

</section>
<section data-markdown>

## Juggling Platform Differences

- Platform wrappers with shared.js within

~~~
     ____________   ___________
    | android.js | |  ios.js   |
    |            | |           |
    | loads  ____|_|____ loads |
    |_______| shared.js |______|
            |           |
            |  Main UI  |
            |___________|


~~~

</section>
<section data-markdown>

## Debugging Crash Reports

- iOS has been easy
- Pain & confusion
    - `Caused by: java.lang.IllegalArgumentException:`
    - Serialization too large?
    - Bad memory cleanup?

</section>
<section data-markdown>

## Future Requests

- Break down the debug wall
- Better docs on embedded usage
- Reproducible installations
- Upgrade paths

</section>
<section data-markdown>

## Future Prospects

- All apps in React Native?
- Is native development still relevant?
- What will our next app contain?

_We are not enemies, but friends. We must not be enemies._

</section>
